{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/opnsense-firewall-setup/","result":{"data":{"asciidoc":{"html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Over the years my home network has been powered by <a href=\"https://www.ui.com/introduction\" target=\"blank\">Ubiquiti</a> hardware - nano HD APs,\nan in-wall AP, a Flex AP, an Outdoor Mesh, network switch, and a USG.\nFor the most part I&#8217;ve been very happy with the hardware, but I&#8217;ve had issues with the USG a few times.</p>\n</div>\n<div class=\"paragraph\">\n<p>There have been occasions where upgrading the USG lead it to stop working, either requiring a factory reset and re-import of settings, or needing to rebuild the internal database.\nThough I was able to ssh into the USG and rebuild the database, it was always a pain.\nI often wouldn&#8217;t know there was an issue until one of my kids complained about the internet not working.\nAlso, there were times where I felt the USG was underpowered, and restricted the total bandwidth I was able to achieve in the house.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_what_to_choose\">What to choose?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>I&#8217;d put off doing anything about it for probably a year or more.\nYeah I know, the typical guy in IT putting off doing anything about their own environment!\nIn late 2022 I finally began looking at options for a replacement,\nboth from <a href=\"https://www.ui.com/introduction\" target=\"blank\">Ubiquiti</a> and other alternatives that would still work with the existing APs I have.\nI happened to be talking about it with a friend and colleague,\n<a href=\"https://www.linkedin.com/in/alghanmi/\" target=\"blank\">Rami</a>,\nwho lives and breathes infrastructure and networking,\nand he suggested I look into <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>I vaguely recalled having heard of <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a>,\n<a href=\"https://www.pfsense.org/\" target=\"blank\">pfsense</a>,\nand similar firewalls over the years but hadn&#8217;t delved deep their capabilities or how to set them up.\n<a href=\"https://www.linkedin.com/in/alghanmi/\" target=\"blank\">Rami</a> admitted there is more up front config required\nwith <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> than an <strong>off the shelf</strong> solution,\nbut it provided a great deal more control over how it worked as well.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_what_about_the_hardware\">What about the hardware?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>As <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> is a piece of software,\nit still needs hardware to run on.\nWhile chatting about it with <a href=\"https://www.linkedin.com/in/alghanmi/\" target=\"blank\">Rami</a>,\nhe suggested I look at the <a href=\"https://www.hardkernel.com/shop/odroid-h3-plus/\" target=\"blank\">ODROID-H3+</a>.\nI was using a small Raspberry Pi device to run <a href=\"https://pi-hole.net/\" target=\"blank\">pihole</a>,\nbut it was pre-assembled and I&#8217;d never really done any device building before.</p>\n</div>\n<div class=\"paragraph\">\n<p>After reading through the details of the <a href=\"https://www.hardkernel.com/shop/odroid-h3-plus/\" target=\"blank\">ODROID-H3+</a>,\nmost of the <strong>work</strong> was already done and it was just putting pieces together,\nwhich I could totally do!\nHere is the list of components I purchased from <a href=\"https://www.hardkernel.com/\" target=\"blank\">HARDKERNEL</a>:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>1 x <a href=\"https://www.hardkernel.com/shop/odroid-h3-plus/\" target=\"blank\">ODROID-H3+</a></p>\n</li>\n<li>\n<p>2 x <a href=\"https://www.hardkernel.com/shop/samsung-16gb-ddr4-pc4-25600-so-dimm/\" target=\"blank\">16GB DDR4 memory</a></p>\n</li>\n<li>\n<p>1 x <a href=\"https://www.hardkernel.com/shop/128gb-emmc-module-h2-2/\" target=\"blank\">128GB eMMC module</a></p>\n</li>\n<li>\n<p>1 x <a href=\"https://www.hardkernel.com/shop/92x92x25mm-dc-cooling-fan-w-pwm-speed-sensor-tacho-2/\" target=\"blank\">Fan</a></p>\n</li>\n<li>\n<p>1 x <a href=\"https://www.hardkernel.com/shop/odroid-h3-case-type-2/\" target=\"blank\">Type 2 case</a></p>\n</li>\n<li>\n<p>1 x <a href=\"https://www.hardkernel.com/shop/15v-4a-power-supply-us-plug/\">15V/4A US power plug</a></p>\n</li>\n</ul>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/odroid-h3-plus.png\" alt=\"ODROID-H3+\" width=\"450\">\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Once everything had arrived, it was construction time!\nAbove is a photo of all the components laid out ready to be put together.\nThe hardest part of the construction was getting the pieces of the case in the right position so they all connected correctly at the end!\nIt took a couple of attempts to get that sorted,\nbut then it came together nicely into the completed unit seen below.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/odroid-h3-plus-case.png\" alt=\"ODROID-H3+ in case\" width=\"450\">\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_opnsense_installation\">OPNsense installation</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>With the hardware ready, now it was time to install <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> and get it running.\nAfter loading the <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> installation onto a USB stick,\nI used the <em>dvd</em> installation type, I plugged it in and booted up the device.</p>\n</div>\n<div class=\"paragraph\">\n<p>I chose to install FreeBSD with the ZFS file system to have journaling enabled.\nI don&#8217;t know whether it&#8217;s necessary, but seemed like a logical approach.\nWhen the installation of the operating system had completed,\nit was unable to find any network interfaces.\nAt this point I was questioning whether I had made the correct decision to build a firewall myself as opposed to buying a pre-packaged solution!</p>\n</div>\n<div class=\"paragraph\">\n<p>As the <a href=\"https://www.hardkernel.com/shop/odroid-h3-plus/\" target=\"blank\">ODROID-H3+</a>\nuses a Realtek RTL8125B network card, FreeBSD was unable to recognize it.\nLuckily I found reference to the problem on a <a href=\"https://cyberdean.fr/blog/realtek-driver-free-bsd/\" target=\"blank\">blog</a>,\nwith handy information on how to resolve it.</p>\n</div>\n<div class=\"paragraph\">\n<p>I first ran <code>pciconf -vl</code> to verify the network cards were present but the driver was <code>none</code>.\nThen I found a driver package for the network card from <a href=\"https://www.freshports.org/net/realtek-re-kmod/\" target=\"blank\">FreshPorts</a>,\nwhich I downloaded and put onto another USB.\nHere are the steps I took to install the network driver:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>mkdir /mnt/usbstick</code></p>\n</li>\n<li>\n<p><code>ls -l /dev/da*</code></p>\n</li>\n<li>\n<p><code>mount -t msdosfs /dev/da1p2 /mnt/usbstick</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>da1</code> is the USB stick, and <code>p2</code> was the first partition</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>pkg add /mnt/usbstick/realtek-re-kmod-v196.04.txz</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>At the time I installed the driver it was <code>v196</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>umount /mnt/usbstick</code> and <code>rm -rf /mnt/usbstick</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Unmount the USB stick and remove the directory created for it</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>To load the driver into the operating system we need to edit <code>/boot/loader.conf.local</code> and add the following:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code>if_re_load=\"YES\"\nif_re_name=\"/boot/modules/if_re.ko\"</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>With the change in place, <code>reboot</code> the device.\nOnce booted, run <code>kldstat</code> to ensure that <code>if_re.ko</code> is loaded successfully.\nLastly, run <code>ifconfig -a</code> to verify the NIC is now present.</p>\n</div>\n<div class=\"paragraph\">\n<p>With the network card now detected, we can assign the interfaces with <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a>.\nIn my case, I assigned <code>re0</code> as the WAN (the internet), and <code>re1</code> as the LAN (internal network).\nThen set the IP address for the LAN and it&#8217;s respective IP range,\nwhich can be customized to your preferences.\nOne possible choice is an IP address of <code>192.168.0.1</code> for the LAN, and a range from <code>192.168.0.3</code> to <code>192.168.0.255</code>.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_opnsense_set_up\">OPNsense set up</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>A neat trick that <a href=\"https://www.linkedin.com/in/alghanmi/\" target=\"blank\">Rami</a> told me was to set up the firewall inside your network!\nDoing this means not interrupting the existing internet in your house until you&#8217;re ready,\nwhich is critical when you have kids that can&#8217;t live without internet,\nand it doesn&#8217;t expose an unsecured and un-configured firewall to potential attack.\nIn this set up, the WAN of the device connects to your main internal network to get its internet.</p>\n</div>\n<div class=\"paragraph\">\n<p>To be able to access the <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> UI from your main home network,\nas it&#8217;s on the WAN side of the firewall, we need to run <code>pfctl -d</code> after every reboot to disable the firewall.\nAs the device isn&#8217;t performing any protection for us yet, there&#8217;s no issue in disabling the firewall while we finish the set up.</p>\n</div>\n<div class=\"paragraph\">\n<p>I also installed <a href=\"https://tailscale.com/\" target=\"blank\">Tailscale</a> by following <a href=\"https://tailscale.com/kb/1097/install-opnsense/\" target=\"blank\">these instructions</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>There are a couple of key things you want to verify in the UI before continuing much further.\nGo to System &#8594; Settings &#8594; Administration and verify the following:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>HTTPS enabled for web protocol</p>\n</li>\n<li>\n<p>HTTP Strict Transport Security enabled</p>\n</li>\n<li>\n<p>Disable DNS Rebinding Checks is unchecked</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>I then created an administrator account and disabled the root user,\nby following <a href=\"https://homenetworkguy.com/how-to/disable-root-user-opnsense/\" target=\"blank\">these instructions</a>,\nto increase security.\nI also enabled multi-factor authentication for the administrator account,\nbased on <a href=\"https://homenetworkguy.com/how-to/enable-multi-factor-authentication-in-opnsense/\" target=\"blank\">this</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>To finish the set up of <a href=\"https://tailscale.com/\" target=\"blank\">Tailscale</a>,\nhead to Interfaces &#8594; Assignments in the UI.\nThere should already be an interface named <strong>tailscale</strong> in the New Interface section,\nclick on the plus icon.\nWe need to enable the interface, and also prevent it from being removed.\nGive the interface a name, set the IPv4 config to static, and set the IPv4 address to the one from <a href=\"https://tailscale.com/\" target=\"blank\">Tailscale</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>Next I set up the VLANs.\nI wanted a separate VLAN for any server or device, another for personal computers and phones, another for work devices, and another for IoT devices.\nWhen creating the interface for a VLAN change the IP address to have <code>/24</code>, as <code>/32</code> is the default.\nIf the default remains, it won&#8217;t think there are any IP addresses available for use.\nWhen all your desired VLANs have been created,\nhead to Services &#8594; DHCPv4 in the UI and for each VLAN enable DHCP and set the desired IP range.</p>\n</div>\n<div class=\"paragraph\">\n<p>By default, access to the internet is disallowed from all VLANs,\nand all VLANs can communicate with each other and the parent, which is the main LAN.\nIn the UI, go to Firewalls &#8594; Rules.\nFor each interface name, set your preferred firewall rules.\nIn my case, I allowed all VLANs to access the internet,\nbut disallowed the IoT VLAN from talking with any other VLAN.</p>\n</div>\n<div class=\"paragraph\">\n<p>That&#8217;s the basic set up for the <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> firewall.\nWith all the above done, I took the next step and replaced the existing USG device with the new firewall!</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_opnsense_and_bonjour_printer\">OPNsense and Bonjour printer</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>As all things do, it worked, to an extent.\nAll usual devices worked as expected with the new firewall, but there were a few exceptions that needed to be handled.\nThe first of which was the printer.</p>\n</div>\n<div class=\"paragraph\">\n<p>To enable printers to use the Bonjour protocol to communicate,\nwe need to install an mDNS repeater into <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a>.\nYou may ask why I want to use Bonjour for printer communication,\nwe have several iPhones and Macs in the house,\nwhich makes it just easier if we do.</p>\n</div>\n<div class=\"paragraph\">\n<p>The instructions for setting up mDNS with <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a>\nare covered <a href=\"https://docs.opnsense.org/manual/how-tos/multicast-dns.html\" target=\"blank\">here</a> in detail.\nFirst step is to install the plugin through the UI.\nOnce the plugin is installed, enable the service and select which network VLANs should be enabled.\nIn my case, I enabled it for the main LAN and the VLAN where all our personal devices are connected,\nincluding the printer itself.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_opnsense_and_a_nintendo_switch\">OPNsense and a Nintendo Switch</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>There was still one device that was having trouble connecting to online play,\nmy son&#8217;s Nintendo Switch!\nLooking at the internet settings of the Nintendo Switch,\nit was showing a NAT type of <strong>D</strong> when at least a <strong>C</strong> is recommended for best online play.</p>\n</div>\n<div class=\"paragraph\">\n<p>I found a great <a href=\"https://blog.jamie.ie/posts/switch-opnsense/\" target=\"blank\">resource</a> explaining what was needed to improve it!\nUnder Services &#8594; DHCPv4, find the VLAN which the Nintendo Switch is connecting to and add a new static DHCP mapping rule\nwith the MAC and IP of the Nintendo Switch.\nThen in Firewall &#8594; NAT &#8594; Outbound, change <strong>Automatic</strong> to <strong>Hybrid</strong> and save the changes.\nNext, create a new rule with the following properties:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Set <strong>Interface</strong> to <em>WAN</em></p>\n</li>\n<li>\n<p>Set it to use <em>IPv4</em></p>\n</li>\n<li>\n<p>Set <strong>Protocol</strong> to <em>any</em></p>\n</li>\n<li>\n<p>For <strong>Source address</strong>, select <em>Single host or Network</em> and set the IP Address to that of the Nintendo Switch with <code>/32</code></p>\n</li>\n<li>\n<p>Set <strong>Destination address</strong> to <em>any</em></p>\n</li>\n<li>\n<p>Set <strong>Static-port</strong> to enabled</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_a_year_of_experiences\">A year of experiences</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>After having used <a href=\"https://opnsense.org/\" target=\"blank\">OPNsense</a> for a year now,\nand performed many minor and several major upgrades in that time,\nI am impressed with how well the software performs and how smooth the upgrades are.\nThere have been several times where I&#8217;ve needed to customize specific configuration for various reasons,\nbut once I got the hang of the UI and how things are set up, I&#8217;ve found it very easy to navigate.</p>\n</div>\n<div class=\"paragraph\">\n<p>There was definitely a learning curve, especially in resolving the issues around network cards not being found, etc.\nBut I feel the experience was a great learning one, and worth it in the long run.</p>\n</div>\n</div>\n</div>","document":{"title":"Setting up an OPNSense Firewall"},"fields":{"slug":"/blog/opnsense-firewall-setup/"},"pageAttributes":{"title":null,"description":null,"date":"February 06, 2024"}}},"pageContext":{"slug":"/blog/opnsense-firewall-setup/"}},"staticQueryHashes":["1000148989","19992949","764694655","78439061"],"slicesMap":{}}